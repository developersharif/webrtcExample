import{initializeApp as N}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";import{getFirestore as V,doc as p,onSnapshot as U,updateDoc as h,addDoc as M,collection as W,getDoc as F}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js";import{getAuth as x,signInAnonymously as J}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-auth.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))d(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&d(f)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function d(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();const P={apiKey:"AIzaSyDnIZ0IfeQ8VwQFyXFLMfrRsoqS_WC_ht4",authDomain:"real-call.firebaseapp.com",projectId:"real-call",storageBucket:"real-call.appspot.com",messagingSenderId:"64872948580",appId:"1:64872948580:web:789f18dfab9e2abb58d071",measurementId:"G-GXE40EG2GL"},G=N(P),l=V(),u="signals",j=async()=>{const n=await y(),r=(await M(W(l,u),{callerId:n.uid,offer:null,answer:null,calleeId:null})).id;return document.location.href+"?room="+r},$=(n,e)=>{const r=p(l,u,n);return U(r,e)},L=async n=>await F(p(l,u,n)),q=async(n,e=null)=>{const r=await y();await h(p(l,u,n),{answer:e,calleeId:r.uid})},z=async(n,e)=>await h(p(l,u,n),{offer:e}),H=async(n,e)=>await h(p(l,u,n),{candidate:e}),K=async n=>await h(p(l,u,n),{answer:null,calleeId:null,offer:null}),y=async()=>{const n=x(G);try{return(await J(n)).user}catch(e){throw console.error("Anonymous authentication failed:",e.message),e}},i=new URLSearchParams(document.location.search).get("room"),S=document.getElementById("createLink"),C=document.getElementById("sdpOfferLink"),D=document.getElementById("copy"),R=document.getElementById("menu"),Q=document.getElementById("dashboard"),X=document.getElementById("controls"),_=document.getElementById("app"),Z=document.getElementById("closeChat");async function Y(){S.innerText="Creating...",console.log("creating Room link");const n=await j();C.value=n,S.innerText="Create Chat Link"}if(i){R.classList.add("hidden"),X.classList.remove("hidden"),_.classList.remove("hidden");const n={iceServers:[{urls:"stun:stun.relay.metered.ca:80"},{urls:"turn:a.relay.metered.ca:80",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:a.relay.metered.ca:80?transport=tcp",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:a.relay.metered.ca:443",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:a.relay.metered.ca:443?transport=tcp",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"}]},e=new RTCPeerConnection(n);let r,d;const o=document.getElementById("localVideo"),c=document.getElementById("remoteVideo"),f=document.getElementById("muteButton"),O=document.getElementById("videoButton"),B={video:!0,audio:{echoCancellation:!0,noiseSuppression:!0}};let g=!0,I=!0;async function w(){const a=await(await y()).uid;return await(await L(i)).data().callerId===a}async function k(){return await(await y()).uid,(await L(i)).data()}async function A(){r=await navigator.mediaDevices.getUserMedia(B),d=new MediaStream,o.srcObject=r,c.srcObject=d,r.getTracks().forEach(t=>{e.addTrack(t,r)}),e.ontrack=t=>{t.streams[0].getTracks().forEach(a=>{d.addTrack(a)})},f.onclick=()=>{r.getAudioTracks().forEach(t=>{t.enabled=!g}),g=!g,f.innerHTML=g?'<i class="fa-solid fa-microphone"></i>':'<i class="fa-solid fa-microphone-slash"></i>'},O.onclick=()=>{r.getVideoTracks().forEach(t=>{t.enabled=I=!I}),O.innerHTML=I?'<i class="fa-solid fa-video"></i>':'<i class="fa-solid fa-video-slash"></i>'},Z.onclick=()=>{var t=window.location.href,a=t.split("?")[0];window.location.href=a}}async function T(){try{if(await w()){e.onicecandidate=async s=>{s.candidate&&(await H(i,JSON.stringify(s.candidate)),console.log(`New Ice Candidate ${JSON.stringify(s.candidate)}`))};const t=await e.createOffer();await e.setLocalDescription(t);const a=JSON.stringify(e.localDescription);await z(i,a),console.log(a)}}catch(t){console.error("Error creating or setting local description:",t)}}async function b(){if(!await w()){console.log("creating SDP answer");const a=await(await k()).offer;if(a&&!e.currentRemoteDescription){e.onicecandidate=async v=>{if(v.candidate){const E=JSON.stringify(e.localDescription);await q(i,E),console.log(E)}};const s=new RTCSessionDescription(JSON.parse(a));await e.setRemoteDescription(s);const m=await e.createAnswer();await e.setLocalDescription(m)}}}A(),setTimeout(async()=>{T(),b(),$(i,async t=>{if(t.exists()){let a=await t.data().answer;if(a&&await w()&&!e.currentRemoteDescription){const m=new RTCSessionDescription(JSON.parse(a));await e.setRemoteDescription(m),console.log(a)}else b();let s=await t.data().candidate;if(s!==void 0&&e.currentRemoteDescription&&!await w()&&e){console.log("IceCandidate Added");const m=JSON.parse(s);e.addIceCandidate(new RTCIceCandidate(m))}}else console.log(`Document with roomId ${i} does not exist.`)})},200),window.addEventListener("beforeunload",async t=>{e.close(),await K(i)})}else S.onclick=Y,R.onclick=()=>{Q.classList.toggle("hidden")},D.onclick=()=>{C.select(),C.setSelectionRange(0,99999),document.execCommand("copy"),D.innerText="Copied"},console.log("Room not exist");
