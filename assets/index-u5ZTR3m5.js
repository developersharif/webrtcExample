import{initializeApp as P}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";import{getFirestore as N,doc as w,onSnapshot as V,updateDoc as h,addDoc as M,collection as U,getDoc as W}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js";import{getAuth as F,signInAnonymously as x}from"https://www.gstatic.com/firebasejs/9.6.2/firebase-auth.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const m of i.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&l(m)}).observe(document,{childList:!0,subtree:!0});function r(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(a){if(a.ep)return;a.ep=!0;const i=r(a);fetch(a.href,i)}})();const J={apiKey:"AIzaSyDnIZ0IfeQ8VwQFyXFLMfrRsoqS_WC_ht4",authDomain:"real-call.firebaseapp.com",projectId:"real-call",storageBucket:"real-call.appspot.com",messagingSenderId:"64872948580",appId:"1:64872948580:web:789f18dfab9e2abb58d071",measurementId:"G-GXE40EG2GL"},G=P(J),u=N(),f="signals",j=async()=>{const e=await y(),r=(await M(U(u,f),{callerId:e.uid,offer:null,answer:null,calleeId:null})).id;return document.location.href+"?room="+r},H=(e,o)=>{const r=w(u,f,e);return V(r,o)},E=async e=>await W(w(u,f,e)),$=async(e,o=null)=>{const r=await y();await h(w(u,f,e),{answer:o,calleeId:r.uid})},q=async(e,o)=>await h(w(u,f,e),{offer:o}),z=async(e,o)=>await h(w(u,f,e),{candidate:o}),K=async e=>await h(w(u,f,e),{answer:null,calleeId:null,offer:null}),y=async()=>{const e=F(G);try{return(await x(e)).user}catch(o){throw console.error("Anonymous authentication failed:",o.message),o}},d=new URLSearchParams(document.location.search).get("room"),S=document.getElementById("createLink"),C=document.getElementById("sdpOfferLink"),L=document.getElementById("copy"),R=document.getElementById("menu"),Q=document.getElementById("dashboard"),X=document.getElementById("controls"),_=document.getElementById("app"),Z=document.getElementById("closeChat");async function Y(){S.innerText="Creating...",console.log("creating Room link");const e=await j();C.value=e,S.innerText="Create Chat Link"}if(d){let o=function(){const t={iceServers:[{urls:"stun:stun.relay.metered.ca:80"},{urls:"turn:standard.relay.metered.ca:80",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:standard.relay.metered.ca:80?transport=tcp",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:standard.relay.metered.ca:443",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"},{urls:"turn:standard.relay.metered.ca:443?transport=tcp",username:"e437f719844bbfd0946a0ee1",credential:"yOVlFtWtndW0oeen"}]};return new RTCPeerConnection(t)},B=function(){return new Promise(async(t,n)=>{try{const c=await y(),s=await E(d);t(s.data())}catch(c){n(c)}})},T=function(t){console.error("Error:",t)};R.classList.add("hidden"),X.classList.remove("hidden"),_.classList.remove("hidden");let e=null;e=o();let r,l;const a=document.getElementById("localVideo"),i=document.getElementById("remoteVideo"),m=document.getElementById("muteButton"),O=document.getElementById("videoButton"),A={video:!0,audio:!1};let p=!0,I=!0;async function g(){const n=await(await y()).uid;return await(await E(d)).data().callerId===n}async function k(){r=await navigator.mediaDevices.getUserMedia(A),l=new MediaStream,a.srcObject=r,i.srcObject=l,r.getTracks().forEach(t=>{e.addTrack(t,r)}),e.ontrack=t=>{t.streams[0].getTracks().forEach(n=>{l.addTrack(n)})},m.onclick=()=>{r.getAudioTracks().forEach(t=>{t.enabled=!p}),p=!p,m.innerHTML=p?'<i class="fa-solid fa-microphone"></i>':'<i class="fa-solid fa-microphone-slash"></i>'},O.onclick=()=>{r.getVideoTracks().forEach(t=>{t.enabled=I=!I}),O.innerHTML=I?'<i class="fa-solid fa-video"></i>':'<i class="fa-solid fa-video-slash"></i>'},Z.onclick=()=>{var t=window.location.href,n=t.split("?")[0];window.location.href=n}}async function b(){try{if(await g()){e.onicecandidate=async c=>{c.candidate&&(await z(d,JSON.stringify(c.candidate)),console.log(`New Ice Candidate ${JSON.stringify(c.candidate)}`))};const t=await e.createOffer();await e.setLocalDescription(t);const n=JSON.stringify(e.localDescription);await q(d,n),console.log(n)}}catch(t){console.error("Error creating or setting local description:",t)}}async function D(){try{if(!await g()){console.log("Creating SDP answer"),e.onicecandidate=async c=>{if(c.candidate){const s=JSON.stringify(e.localDescription);await $(d,s),console.log("SDP Answer:",s)}};const n=await(await B()).offer;if(n&&!e.currentRemoteDescription){console.log("Creating SDP answer...");const c=new RTCSessionDescription(JSON.parse(n));await e.setRemoteDescription(c);const s=await e.createAnswer();await e.setLocalDescription(s)}}}catch(t){console.error("Error creating SDP answer:",t)}}async function v(t){try{if(t.exists()){let n=await t.data().answer;if(await t.data().offer===null&&await t.data().candidate===null&&b(),n&&await g()&&!e.currentRemoteDescription){const s=new RTCSessionDescription(JSON.parse(n));await e.setRemoteDescription(s),console.log(n)}else D();let c=await t.data().candidate;if(c!==void 0&&e.currentRemoteDescription&&!await g()&&e){console.log("IceCandidate Added");const s=JSON.parse(c);e.addIceCandidate(new RTCIceCandidate(s))}}else console.log(`roomId ${d} does not exist.`),window.location.replace(window.location.origin+window.location.pathname)}catch(n){T(n)}}k(),setTimeout(async()=>{await b(),D(),H(d,v)},200),window.addEventListener("beforeunload",async t=>{t.preventDefault(),e.close(),await K(d);const n="Resetting room. Are you sure?";return t.returnValue=n,n})}else S.onclick=Y,R.onclick=()=>{Q.classList.toggle("hidden")},L.onclick=()=>{C.select(),C.setSelectionRange(0,99999),document.execCommand("copy"),L.innerText="Copied"},console.log("Room not exist");
